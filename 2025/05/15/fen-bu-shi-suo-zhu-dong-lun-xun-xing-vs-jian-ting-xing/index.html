<!DOCTYPE html><html lang="zh-CN"><head><!-- hexo injector head_begin start --><style type="text/css">.douban-card-block {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    max-height: 400px;
}

.douban-card {
    display: flex;
    margin: 30px 10px;
    padding: 15px;
    border-radius: 15px;
    position: relative;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    color: antiquewhite;
    text-decoration: none;
}

.douban-card:hover {
    text-decoration: none;
}

.douban-card-bgimg {
    position: absolute;
    width: 115%;
    height: 115%;
    filter: blur(15px) brightness(0.6);
    background-size: 100%;
    background-position: center;
    background-repeat: no-repeat;
}

.douban-card-img {
    position: relative;
    height: 130px;
    width: 80px;
    background-size: 100%;
    background-position: center;
    background-repeat: no-repeat;
}

.douban-card-left:hover .douban-card-img {
    filter: blur(5px) brightness(0.6);
    transform: perspective(800px) rotateX(180deg);
}

.douban-card-left .douban-card-img {
    transition: all 500ms ease;
}

.douban-card-left {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.douban-card-left .douban-card-status {
    height: 130px;
    width: 80px;
    text-align: center;
    font-weight: bold;
    position: absolute;
    left: 0;
    top: 30%;
    transform: rotateX(180deg);
    backface-visibility: hidden;
    transition: all 500ms ease;
}

.douban-card-left:hover .douban-card-status {
    transform: perspective(800px) rotateX(0deg);
}

.douban-card-right {
    position: relative;
    display: flex;
    flex-direction: column;
    margin-left: 12px;
    font-size: 16px;
    font-family: "Courier New", Courier, monospace;
    line-height: 1.3;
    color: antiquewhite;
}

.douban-card-item {
    margin-top: 4px;
}
</style><!-- hexo injector head_begin end --><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="ç¼–ç¨‹è·¯ä¸Šçš„éšç¬”"><title>åˆ†å¸ƒå¼é”ï¼šä¸»åŠ¨è½®è¯¢å‹vsç›‘å¬å›è°ƒå‹ | LuoZero's World</title><link rel="preload" href="/Blog/CangEr.woff2" as="font" type="font/woff2" crossorigin><style>@font-face {
  font-family: "Cang Er";
  src: url('/Blog/CangEr.woff2') format('woff2');
}
</style><link rel="stylesheet" type="text/css" href="/Blog/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/Blog/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/Blog/favicon.ico"><link rel="apple-touch-icon" href="/Blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/Blog/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><div class="darkmode-toggle">ğŸŒ“</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 7.3.0"><link rel="stylesheet" href="/Blog/css/prism-ghcolors.css" type="text/css">
<link rel="stylesheet" href="/Blog/css/prism-line-numbers.css" type="text/css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">åˆ†å¸ƒå¼é”ï¼šä¸»åŠ¨è½®è¯¢å‹vsç›‘å¬å›è°ƒå‹</h1><a id="logo" href="/Blog/.">LuoZero's World</a><p class="description">å’Œå…‰åŒå°˜,ä¸æ—¶èˆ’å·</p></div><div id="nav-menu"><a class="current" href="/Blog/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/Blog/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/Blog/about/"><i class="fa fa-user"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">åˆ†å¸ƒå¼é”ï¼šä¸»åŠ¨è½®è¯¢å‹vsç›‘å¬å›è°ƒå‹</h1><div class="post-meta">2025-05-15<span> | </span><span class="category"><a href="/Blog/categories/%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/">é¡¹ç›®æ€»ç»“</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> é˜…è¯»</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 3.2k</span><span class="post-meta-item-text"> å­—</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 12</span><span class="post-meta-item-text"> åˆ†é’Ÿ</span></span></span></div><a class="disqus-comment-count" href="/Blog/2025/05/15/fen-bu-shi-suo-zhu-dong-lun-xun-xing-vs-jian-ting-xing/#waline"><span class="waline-comment-count" id="/Blog/2025/05/15/fen-bu-shi-suo-zhu-dong-lun-xun-xing-vs-jian-ting-xing/"></span><span> æ¡è¯„è®º</span></a><div class="post-content"><p>æœ¬æ–‡å°†ä»‹ç»åˆ†å¸ƒå¼é”çš„ä¸¤ç§æ¨¡å‹ï¼Œå…±åˆ†ä¸‰ä¸ªç« èŠ‚ï¼Œç¬¬ä¸€ç« èŠ‚è®²è®²å¦‚ä½•é€šè¿‡<code>redis</code>å®ç°ä¸»åŠ¨è½®è¯¢å‹åˆ†å¸ƒå¼é”ï¼›ç¬¬äºŒç« èŠ‚ç®€è¦è¯´ä¸‹<code>etcd</code>ä¸­å¦‚ä½•å®ç°ç›‘å¬å›è°ƒå‹é”ï¼Œç¬¬ä¸‰ç« èŠ‚å±•ç¤ºä¸¤ç§æ¨¡å‹åœ¨ä¸åŒåœºæ™¯ä¸‹çš„æ€§èƒ½æ¯”å¯¹ä¸èµ„æºæ¶ˆè€—æƒ…å†µã€‚</p>
<span id="more"></span>
<p>å¹¶å‘åœºæ™¯ä¸­ï¼Œâ€œé”â€ç”¨äºå¯¹ä¸´ç•Œèµ„æºè¿›è¡Œä¿æŠ¤ï¼Œè®©æ··ä¹±çš„å¹¶å‘è®¿é—®è¡Œä¸ºåœ¨ä¸´ç•ŒåŒºå˜ä¸ºç§©åºçš„ä¸²è¡Œè®¿é—®è¡Œä¸ºã€‚åœ¨æœ¬åœ°åœºæ™¯ä¸‹ï¼Œç”±äºè¿›ç¨‹å†…çº¿ç¨‹å¯ä»¥å…±äº«è¿›ç¨‹æ•°æ®ï¼Œäº’æ–¥é”çš„å®ç°è¾ƒä¸ºç®€å•ï¼›è€Œåˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è·¨åŸŸå¯¹å¤šä¸ªç‰©ç†èŠ‚ç‚¹æ‰§è¡ŒåŠ é”æ“ä½œï¼Œæ•…è€Œéœ€è¦ä¾èµ–åƒ<code>redis</code>ã€<code>mysql</code>ç­‰çŠ¶æ€å­˜å‚¨ç»„ä»¶ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå®ç°â€œåˆ†å¸ƒå¼é”â€ã€‚</p>
<h2><span id="ä¸»åŠ¨è½®è¯¢å‹">ä¸»åŠ¨è½®è¯¢å‹</span></h2><p>æœ¬èŠ‚åŸºäº<a target="_blank" rel="noopener" href="https://github.com/redis/go-redis">go-redis</a>ï¼Œå®ç°äº†å•ç‚¹æ¨¡å¼ä¸‹ä¸»åŠ¨è½®è¯¢æ¨¡å‹çš„åˆ†å¸ƒå¼é”ï¼ŒåŒæ—¶é¢å¤–å®ç°äº†â€œçº¢é”â€çš„åŸºæœ¬åŠŸèƒ½ï¼Œä»£ç å·²æ”¾å…¥ç¬”è€…<a target="_blank" rel="noopener" href="https://github.com/LuoZero-World/distributed-lock">Githubä»“åº“</a>ã€‚ç”±äºä¸ªäººæ°´å¹³æœ‰é™ï¼Œå¦‚æœ‰ä¸å½“ä¹‹å¤„ï¼Œæ•¬è¯·è°…è§£ï¼Œå¹¶æ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ğŸ˜Š</p>
<h3><span id="å®ç°åŸç†">å®ç°åŸç†</span></h3><ol>
<li><p><strong>åˆ›å»ºåˆ†å¸ƒå¼é”</strong><br>ç›¸æ¯”äºåˆ›å»ºé”ï¼Œè¯¥æ“ä½œæ›´ç±»ä¼¼äºâ€œåˆ›å»ºä¸é”çš„è¿æ¥â€ï¼Œä¸ºç®€åŒ–æ“ä½œå«æ³•ï¼Œä¸‹è¿°ä¸€å¾‹ä½¿ç”¨â€œåˆ›å»ºåˆ†å¸ƒå¼é”â€ã€‚ä»£ç ä¸­ï¼Œç»“æ„ä½“<code>RedisLock</code>ä¸­å‡†å¤‡äº†å°†å­˜å‚¨äº<code>Redis</code>ä¸­çš„KVå¯¹ï¼Œå…¶ä¸­keyå­—æ®µç”¨äºå”¯ä¸€æ ‡è¯†ä¸€æŠŠåˆ†å¸ƒå¼é”ï¼Œè€Œvalueå­—æ®µç”¨äºæ ‡è¯†åŠ é”çš„ä¸»ä½“æ–¹èº«ä»½ï¼Œå…·ä½“ä½¿ç”¨[ä¸»æœºIP+è¿›ç¨‹ID+ Goåç¨‹ ID]å®ç°â€œèº«ä»½ç»‘å®šâ€</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RedisLock <span class="keyword">struct</span> &#123;</span><br><span class="line">    LockOptions</span><br><span class="line">    key    <span class="type">string</span></span><br><span class="line">    token  <span class="type">string</span> <span class="comment">// è¡¨ç¤ºåˆ†å¸ƒå¼ç¯å¢ƒä¸‹[ä¸»æœº_è¿›ç¨‹_åç¨‹]æƒ³è¦è·å¾—æ­¤é”</span></span><br><span class="line">    client *redis.Client</span><br><span class="line"></span><br><span class="line">    <span class="comment">//çœ‹é—¨ç‹—è¿è¡Œæ ‡è¯† 0æœªè¿è¡Œ 1æ­£åœ¨è¿è¡Œ</span></span><br><span class="line">    runningWatchDog <span class="type">int32</span></span><br><span class="line">    <span class="comment">//åœæ­¢çœ‹é—¨ç‹—</span></span><br><span class="line">    stopWatchDog context.CancelFunc</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRedisLock</span><span class="params">(key <span class="type">string</span>, client *redis.Client, opts ...LockOption)</span></span> *RedisLock &#123;</span><br><span class="line">    rLock := RedisLock&#123;</span><br><span class="line">    key:    REDIS_LOCK_KEY_PREFIX + key,</span><br><span class="line">    token:  utils.GenerateID(),</span><br><span class="line">    client: client,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;</span><br><span class="line">    opt(&amp;rLock.LockOptions)</span><br><span class="line">    &#125;</span><br><span class="line">    repairLock(&amp;rLock.LockOptions)</span><br><span class="line">    <span class="keyword">return</span> &amp;rLock</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>åŠ é”</strong><br>åŠ é”æ“ä½œåˆ†ä¸ºé˜»å¡å’Œéé˜»å¡æ¨¡å¼ï¼Œå¯ä»¥åœ¨åˆ›å»ºåˆ†å¸ƒå¼é”æ—¶è¿›è¡Œé…ç½®ã€‚éé˜»å¡æ¨¡å¼ä¸‹ï¼Œåªä¼šæ‰§è¡Œä¸€æ¬¡åŠ é”å°è¯•ï¼ˆ<strong>SETNXæ“ä½œä¿è¯åŸå­æ€§ï¼Œä¸å¯é‡å…¥</strong>ï¼‰ï¼Œå€˜è‹¥å¤±è´¥ï¼Œå°±ç›´æ¥è¿”å›é”™è¯¯ï¼›é˜»å¡æ¨¡å¼ä¸‹ï¼Œä¼šé€šè¿‡è®¡æ—¶å™¨ï¼Œæ¯éš”50 msæ‰§è¡Œä¸€æ¬¡åŠ é”å°è¯•ï¼Œå¦‚æœæŸæ¬¡è¯·æ±‚åŠ é”æˆåŠŸåˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™è¾¾åˆ°ç­‰é”è¶…æ—¶é˜ˆå€¼æˆ–è€…ä¸­é€”å‘ç”Ÿäº†é¢„æœŸä¹‹å¤–çš„é”™è¯¯æ—¶ç»ˆæ­¢æµç¨‹ã€‚</p>
</li>
<li><p><strong>è§£é”</strong><br>è§£é”æ“ä½œåŸºäºLuaè„šæœ¬æ‰§è¡Œï¼Œä¿è¯æ“ä½œçš„åŸå­æ€§ã€‚è„šæœ¬æ‰§è¡Œæ—¶é¦–å…ˆæ ¡éªŒå½“å‰æ“ä½œè€…æ˜¯å¦æ‹¥æœ‰é”çš„æ‰€æœ‰æƒï¼Œæ˜¯åˆ™è§£é”ï¼Œå¦åˆ™è¿”å›é”™è¯¯</p>
</li>
</ol>
<h3><span id="æŠ€æœ¯éš¾ç‚¹">æŠ€æœ¯éš¾ç‚¹</span></h3><ol>
<li><p><strong>æ­»é”é—®é¢˜</strong><br>å®¢æˆ·ç«¯åŠ é”åå› è¿›ç¨‹å´©æºƒã€ç½‘ç»œå»¶è¿Ÿç­‰é—®é¢˜æ— æ³•æ­£å¸¸é‡Šæ”¾é”ï¼Œå¯¼è‡´é”æ°¸ä¹…ä¸å¯ç”¨ã€‚å¯ä»¥åœ¨<code>Redis</code>ä¸­ä¸ºæ¯ä¸€æ¡é”è®°å½•è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ŒåŠ é”åè¶…è¿‡è¿™ä¸ªæ—¶é—´é”ä¾¿ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œä½†æ˜¯å½“ä¸šåŠ¡å®é™…å¤„ç†æ—¶é—´è¶…è¿‡è¶…æ—¶æ—¶é—´æ—¶ï¼Œä¸šåŠ¡å¤„ç†æ–¹çš„é”ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚<br>åœ¨<code>Redisson</code>ä¸­çš„è§£å†³æ–¹æ¡ˆæ˜¯â€œ<strong>çœ‹é—¨ç‹—ç­–ç•¥</strong>â€ï¼Œåœ¨é”çš„æŒæœ‰æ–¹æ‰§è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†çš„è¿‡ç¨‹ä¸­æ—¶ï¼Œéœ€è¦å¼‚æ­¥å¯åŠ¨ä¸€ä¸ªçœ‹é—¨ç‹—å®ˆæŠ¤åç¨‹ï¼ŒæŒç»­ä¸ºåˆ†å¸ƒå¼é”çš„è¿‡æœŸé˜ˆå€¼è¿›è¡Œå»¶æœŸæ“ä½œã€‚</p>
</li>
<li><p><strong>å¼±ä¸€è‡´æ€§é—®é¢˜</strong><br>é¿å…å•ç‚¹æ•…éšœå¼•èµ·æ•°æ®ä¸¢å¤±é—®é¢˜ï¼Œ<code>Redis</code>ä¼šåŸºäºä¸»ä»å¤åˆ¶çš„æ–¹å¼å®ç°æ•°æ®å¤‡ä»½å¢åŠ æœåŠ¡çš„å®¹é”™æ€§ã€‚ä¸ºäº†ä¿è¯æœåŠ¡çš„å¯ç”¨æ€§å’Œååé‡ï¼Œ<code>Redis</code>åœ¨è¿›è¡Œæ•°æ®çš„ä¸»ä»åŒæ­¥æ—¶ï¼Œé‡‡ç”¨çš„æ˜¯å¼‚æ­¥æ‰§è¡Œæœºåˆ¶ã€‚è¿™ç§å¼±ä¸€è‡´æ€§åŒæ­¥å°±ä¼šå¯¼è‡´ï¼Œå½“ä½¿ç”¨æ–¹Aåœ¨ä¸»èŠ‚ç‚¹åŠ é”æˆåŠŸåï¼Œä¸»èŠ‚ç‚¹çªç„¶å®•æœºï¼Œæ•°æ®è¿˜æœªåŒæ­¥è‡³ä»èŠ‚ç‚¹ï¼Œè€Œåä»èŠ‚ç‚¹å‡çº§ä¸ºä¸»èŠ‚ç‚¹é€ æˆé”è®°å½•ä¸¢å¤±ã€‚<br>åœ¨<code>Redisson</code>ä¸­çš„è§£å†³æ–¹æ¡ˆæ˜¯â€œ<strong>çº¢é”</strong>â€ï¼Œè¿™æ˜¯ä¸€ç§åŸºäºå¤š<code>Redis</code>èŠ‚ç‚¹çš„åˆ†å¸ƒå¼é”å¢å¼ºæ–¹æ¡ˆï¼Œé€šè¿‡å‘è‡³å°‘5ä¸ªç‹¬ç«‹èŠ‚ç‚¹å‘èµ·åŠ é”è¯·æ±‚å¹¶éœ€è·å¾—åŠæ•°ä»¥ä¸ŠæˆåŠŸå“åº”æ¥ç¡®ä¿é”çš„äº’æ–¥æ€§ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯<strong>é€šè¿‡å¤šæ•°æ´¾æŠ•ç¥¨æœºåˆ¶è§„é¿å•èŠ‚ç‚¹æ•…éšœé£é™©</strong>ã€‚è¯¥æ–¹æ¡ˆç½‘ç»œå¼€é”€è¾ƒå¤§ä¸”å®ç°å¤æ‚ï¼Œå› æ­¤åœ¨å¤šæ•°æƒ…å†µä¸‹å·²è¢«å…¶ä»–æ›¿ä»£æ–¹æ¡ˆå–ä»£ã€‚</p>
</li>
</ol>
<h2><span id="ç›‘å¬å›è°ƒå‹">ç›‘å¬å›è°ƒå‹</span></h2><p>ç›‘å¬å›è°ƒå‹é”åœ¨å–é”å¤±è´¥æ—¶ï¼Œå¹¶ä¸ä¼šåƒä¸»åŠ¨è½®è¯¢å‹é”æŒç»­è¯·æ±‚é”ï¼Œè€Œæ˜¯ä¼šç›‘å¬é”çš„åˆ é™¤äº‹ä»¶ï¼šå½“åˆ é™¤äº‹ä»¶å‘ç”Ÿè¯´æ˜é”è¢«é‡Šæ”¾äº†ï¼Œæ­¤æ—¶æ‰ç»§ç»­å°è¯•å–é”ã€‚<br>æœ¬èŠ‚å°†é‡ç‚¹åˆ†æç›‘å¬å›è°ƒå‹åˆ†å¸ƒå¼é”çš„ä¸€ä¸ªå·¥ç¨‹å®è·µæ¡ˆä¾‹â€”â€”<code>etcd</code>åˆ†å¸ƒå¼é”ã€‚<a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd">etcd</a>æ˜¯ä¸€æ¬¾é€‚åˆç”¨äºå…±äº«é…ç½®å’ŒæœåŠ¡å‘ç°çš„åˆ†å¸ƒå¼KVå­˜å‚¨ç»„ä»¶ï¼Œåº•å±‚åŸºäºåˆ†å¸ƒå¼å…±è¯†ç®—æ³•Raftåè®®ä¿è¯äº†å­˜å‚¨æœåŠ¡çš„å¼ºä¸€è‡´æ€§å’Œé«˜å¯ç”¨ã€‚</p>
<h3><span id="å®ç°åŸç†">å®ç°åŸç†</span></h3><ol>
<li><p><strong>åˆ›å»ºåˆ†å¸ƒå¼é”</strong><br>ç»“æ„ä½“<code>Session</code>è¡¨ç¤ºä¸€æ¬¡è®¿é—®ä¼šè¯ï¼ŒèƒŒåå¯¹åº”çš„æ˜¯ä¸€ç¬”ç§Ÿçº¦ï¼Œç”¨æˆ·è°ƒç”¨<code>NewSession</code>æ–¹æ³•æ„é€ <code>Session</code>å®ä¾‹æ—¶ï¼Œé¦–å…ˆç”³è¯·åˆ°ä¸€ä¸ªç§Ÿçº¦IDï¼Œç„¶å<strong>å¼‚æ­¥å¼€å¯ä¸€ä¸ªå®ˆæŠ¤åç¨‹ï¼Œè¿›è¡Œç§Ÿçº¦ç»­æœŸçš„ç›¸å…³å¤„ç†</strong>ã€‚<br>ç»“æ„ä½“<code>Mutex</code>è¡¨ç¤ºåˆ†å¸ƒå¼é”ï¼Œå…¶ä¸­æ ¸å¿ƒå­—æ®µåŒ…æ‹¬è®¿é—®ä¼šè¯sã€åˆ†å¸ƒå¼é”çš„å…¬å…±å‰ç¼€pfxã€pfxå’Œç§Ÿçº¦IDæ‹¼æ¥è€Œæˆçš„é”ä½¿ç”¨æ–¹keyå­—æ®µmyKeyï¼Œä»¥åŠé”ä½¿ç”¨æ–¹åœ¨pfxä¸‹å¯¹åº”çš„ç‰ˆæœ¬å­—æ®µmyRev</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Session <span class="keyword">struct</span> &#123;</span><br><span class="line">    client *v3.Client</span><br><span class="line">    opts   *sessionOptions</span><br><span class="line">    id     v3.LeaseID</span><br><span class="line"></span><br><span class="line">    cancel context.CancelFunc</span><br><span class="line">    donec  &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSession</span><span class="params">(client *v3.Client, opts ...SessionOption)</span></span> (*Session, <span class="type">error</span>) &#123;</span><br><span class="line">    lg := client.GetLogger()</span><br><span class="line">    ops := &amp;sessionOptions&#123;ttl: defaultSessionTTL, ctx: client.Ctx()&#125;</span><br><span class="line">    <span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;</span><br><span class="line">        opt(ops, lg)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    id := ops.leaseID</span><br><span class="line">    <span class="keyword">if</span> id == v3.NoLease &#123;</span><br><span class="line">        resp, err := client.Grant(ops.ctx, <span class="type">int64</span>(ops.ttl))</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">        id = resp.ID</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx, cancel := context.WithCancel(ops.ctx)</span><br><span class="line">    keepAlive, err := client.KeepAlive(ctx, id)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || keepAlive == <span class="literal">nil</span> &#123;</span><br><span class="line">        cancel()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    donec := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    s := &amp;Session&#123;client: client, opts: ops, id: id, cancel: cancel, donec: donec&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// keep the lease alive until client error or cancelled context</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> <span class="built_in">close</span>(donec)</span><br><span class="line">        <span class="keyword">for</span> <span class="keyword">range</span> keepAlive &#123;</span><br><span class="line">            <span class="comment">// eat messages until keep alive channel closes</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s,<span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Mutex <span class="keyword">struct</span> &#123;</span><br><span class="line">    s *Session</span><br><span class="line">    </span><br><span class="line">    pfx   <span class="type">string</span></span><br><span class="line">    myKey <span class="type">string</span></span><br><span class="line">    myRev <span class="type">int64</span></span><br><span class="line">    hdr   *pb.ResponseHeader</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMutex</span><span class="params">(s *Session, pfx <span class="type">string</span>)</span></span> *Mutex &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;Mutex&#123;s, pfx + <span class="string">&quot;/&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">-1</span>, <span class="literal">nil</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>åŠ é”</strong><br>è°ƒç”¨<code>Mutex.tryAcquire</code>æ–¹æ³•å°è¯•æ’å…¥myKeyï¼ŒåŒæ—¶è·å–å½“å‰é”çš„å®é™…æŒæœ‰è€…ã€‚å¦‚æœå½“å‰é”ä»æœªè¢«å ç”¨ï¼Œæˆ–è€…é”æŒæœ‰è€…çš„ç‰ˆæœ¬å·ä¸è°ƒç”¨æ–¹çš„ç‰ˆæœ¬å·ä¸€è‡´ï¼Œåˆ™ä»£è¡¨åŠ é”æˆåŠŸï¼›å¦åˆ™é”å·²è¢«ä»–äººå ç”¨ï¼Œè°ƒç”¨<code>waitDeletes</code>æ–¹æ³•ï¼Œç›‘å¬ç‰ˆæœ¬å·å°äºè‡ªå·±ä¸”æœ€æ¥è¿‘äºè‡ªå·±çš„é”è®°å½•æ•°æ®çš„åˆ é™¤äº‹ä»¶ã€‚å½“æ¥æ”¶åˆ°è§£é”äº‹ä»¶åï¼Œæ£€æŸ¥è‡ªèº«ç§Ÿçº¦æ˜¯å¦è¿‡æœŸï¼Œæ²¡æœ‰åˆ™åŠ é”æˆåŠŸ</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> Lock(ctx context.Context) <span class="type">error</span> &#123;</span><br><span class="line">    resp, err := m.tryAcquire(ctx)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if no key on prefix / the minimum rev is key, already hold the lock</span></span><br><span class="line">    ownerKey := resp.Responses[<span class="number">1</span>].GetResponseRange().Kvs</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(ownerKey) == <span class="number">0</span> || ownerKey[<span class="number">0</span>].CreateRevision == m.myRev &#123;</span><br><span class="line">        m.hdr = resp.Header</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    client := m.s.Client()</span><br><span class="line">    <span class="comment">// wait for deletion revisions prior to myKey</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> early termination if the session key is deleted before other session keys with smaller revisions.</span></span><br><span class="line">    _, werr := waitDeletes(ctx, client, m.pfx, m.myRev<span class="number">-1</span>)</span><br><span class="line">    <span class="comment">// release lock key if wait failed</span></span><br><span class="line">    <span class="keyword">if</span> werr != <span class="literal">nil</span> &#123;</span><br><span class="line">        m.Unlock(client.Ctx())</span><br><span class="line">        <span class="keyword">return</span> werr</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// make sure the session is not expired, and the owner key still exists.</span></span><br><span class="line">    gresp, werr := client.Get(ctx, m.myKey)</span><br><span class="line">    <span class="keyword">if</span> werr != <span class="literal">nil</span> &#123;</span><br><span class="line">        m.Unlock(client.Ctx())</span><br><span class="line">        <span class="keyword">return</span> werr</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(gresp.Kvs) == <span class="number">0</span> &#123; <span class="comment">// is the session key lost?</span></span><br><span class="line">        <span class="keyword">return</span> ErrSessionExpired</span><br><span class="line">    &#125;</span><br><span class="line">    m.hdr = gresp.Header</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ç›‘å¬</strong><br><code>waitDeletes</code>æ–¹æ³•åŸºäºä¸€ä¸ªforå¾ªç¯è‡ªæ—‹ï¼Œæ¯è½®å¤„ç†ä¸­ä¼šè·å–ç‰ˆæœ¬å·å°äºè‡ªå·±ä¸”æœ€æ¥è¿‘äºè‡ªå·±çš„åŠ é”æ–¹keyï¼Œå¦‚æœkeyä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜è‡ªå·±çš„ç‰ˆæœ¬å·å·²ç»æ˜¯æœ€å°çš„ï¼Œé€€å‡ºç›‘å¬ï¼›å¦åˆ™è°ƒç”¨<code>waitDelete</code>æ–¹æ³•é˜»å¡ç›‘å¬è¿™ä¸ª keyçš„åˆ é™¤äº‹ä»¶ã€‚</p>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">waitDeletes</span><span class="params">(ctx context.Context, client *v3.Client, pfx <span class="type">string</span>, maxCreateRev <span class="type">int64</span>)</span></span> (*pb.ResponseHeader, <span class="type">error</span>) &#123;</span><br><span class="line">    getOpts := <span class="built_in">append</span>(v3.WithLastCreate(), v3.WithMaxCreateRev(maxCreateRev))</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        resp, err := client.Get(ctx, pfx, getOpts...)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(resp.Kvs) == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> resp.Header, <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        lastKey := <span class="type">string</span>(resp.Kvs[<span class="number">0</span>].Key)</span><br><span class="line">        <span class="keyword">if</span> err = waitDelete(ctx, client, lastKey, resp.Header.Revision); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">waitDelete</span><span class="params">(ctx context.Context, client *v3.Client, key <span class="type">string</span>, rev <span class="type">int64</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    cctx, cancel := context.WithCancel(ctx)</span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> wr v3.WatchResponse</span><br><span class="line">    wch := client.Watch(cctx, key, v3.WithRev(rev))</span><br><span class="line">    <span class="keyword">for</span> wr = <span class="keyword">range</span> wch &#123;</span><br><span class="line">        <span class="keyword">for</span> _, ev := <span class="keyword">range</span> wr.Events &#123;</span><br><span class="line">            <span class="keyword">if</span> ev.Type == mvccpb.DELETE &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := wr.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := ctx.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">&quot;lost watcher waiting for delete&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>è§£é”</strong><br>ç›´æ¥åˆ é™¤è°ƒç”¨æ–¹çš„KVå¯¹è®°å½•å³å¯ï¼Œå¦‚æœè°ƒç”¨æ–¹æ˜¯æŒæœ‰é”çš„è§’è‰²ï¼Œé‚£ä¹ˆåˆ é™¤KVå¯¹è®°å½•ä»£è¡¨çœŸæ­£æ„ä¹‰ä¸Šçš„è§£é”åŠ¨ä½œï¼›åä¹‹è°ƒç”¨æ–¹å¹¶æ— æŒæœ‰é”ï¼Œåˆ é™¤KVå¯¹å°±ä»£è¡¨é€€å‡ºäº†æŠ¢é”æµç¨‹ï¼Œä¸ä¼šå¯¹æµç¨‹äº§ç”Ÿè´Ÿé¢å½±å“ã€‚</p>
</li>
</ol>
<h3><span id="æŠ€æœ¯éš¾ç‚¹">æŠ€æœ¯éš¾ç‚¹</span></h3><p>1.<strong>æ­»é”é—®é¢˜</strong><br><code>etcd</code>æä¾›äº†ç§Ÿçº¦æœºåˆ¶ï¼Œä¸€æ—¦è¾¾åˆ°ç§Ÿçº¦ä¸Šè§„å®šçš„æˆªæ­¢æ—¶é—´ï¼Œç§Ÿçº¦å°±ä¼šå¤±å»æ•ˆåŠ›ï¼Œè¿™ç±»ä¼¼äº<code>Redis</code>ä¸­çš„è¶…æ—¶æ—¶é—´ã€‚åŒæ—¶ï¼Œ<code>etcd</code>ä¸­è¿˜æä¾›äº†ç»­çº¦æœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç»­çº¦æ“ä½œæ¥å»¶è¿Ÿç§Ÿçº¦çš„è¿‡æœŸæ—¶é—´ï¼Œè¿™ç±»ä¼¼äº<code>Redisson</code>ä¸­çš„çœ‹é—¨ç‹—ç­–ç•¥ã€‚</p>
<p>2.<strong>æƒŠç¾¤æ•ˆåº”</strong><br>ç›‘å¬å›è°ƒå‹é”çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å‡ºç°è¿™æ ·ä¸€ç§æƒ…å†µï¼šå¦‚æœä¸€æŠŠåˆ†å¸ƒå¼é”çš„ç«äº‰æ¯”è¾ƒæ¿€çƒˆï¼Œé‚£ä¹ˆ<strong>é”çš„é‡Šæ”¾äº‹ä»¶å¯èƒ½åŒæ—¶è¢«å¤šä¸ªçš„å–é”æ–¹æ‰€ç›‘å¬ï¼Œä¸€æ—¦é”è¢«é‡Šæ”¾åæ‰€æœ‰çš„å–é”æ–¹éƒ½ä¼šä¸€æ‹¥è€Œä¸Š</strong>ï¼Œç„¶è€Œä¸€ä¸ªè½®æ¬¡ä¸­åªæœ‰ä¸€ä¸ªå–é”æ–¹èƒ½å¤Ÿå–é”æˆåŠŸï¼Œå› æ­¤è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šå­˜åœ¨å¤§é‡æ€§èƒ½æŸè€—ï¼Œä¸”é‡Šæ”¾é”æ—¶åˆ»ç¬é—´æ¿€å¢çš„è¯·æ±‚æµé‡ä¹Ÿå¯èƒ½ä¼šå¯¹ç³»ç»Ÿç¨³å®šæ€§äº§ç”Ÿè´Ÿé¢æ•ˆåº”ã€‚<br><code>etcd</code>ä¸­åŸºäºé”å‰ç¼€å’Œç‰ˆæœ¬å·æœºåˆ¶æå‡ºçš„è§£å†³æ–¹æ¡ˆï¼šå¯¹äºå¯¹äºåŒä¸€æŠŠåˆ†å¸ƒå¼é”ï¼Œé”è®°å½•keyæ‹¥æœ‰å…±åŒçš„å‰ç¼€ï¼Œä½œä¸ºé”çš„æ ‡è¯†ã€‚åŠ é”æ–¹åŠ é”æ—¶ï¼Œä¼šä»¥é”å‰ç¼€æ‹¼æ¥ä¸Šè‡ªèº«ç§Ÿçº¦IDï¼Œç”Ÿæˆå®Œæ•´çš„keyï¼Œå› æ­¤<strong>åŠ é”æ–¹keyéƒ½æ˜¯ä¸åŒçš„</strong>ï¼Œéƒ½èƒ½æ’å…¥é”è®°å½•æ•°æ®ã€‚æ¯ä¸ªåŠ é”æ–¹æ’å…¥é”è®°å½•æ•°æ®æ—¶ï¼Œä¼šè·å¾—è‡ªèº«keyå¤„åœ¨é”å‰ç¼€èŒƒå›´ä¸‹å”¯ä¸€ä¸”é€’å¢çš„ç‰ˆæœ¬å·ã€‚<strong>åŠ é”æ–¹æ’å…¥åŠ é”è®°å½•æ•°æ®ä¸æ„å‘³ç€åŠ é”æˆåŠŸ</strong>ï¼Œè€Œæ˜¯éœ€è¦åœ¨æ’å…¥æ•°æ®åæŸ¥è¯¢ä¸€æ¬¡é”å‰ç¼€ä¸‹çš„è®°å½•åˆ—è¡¨ï¼Œåˆ¤å®šè‡ªèº«keyå¯¹åº”çš„ç‰ˆæœ¬å·æ˜¯å¦ä¸ºå…¶ä¸­æœ€å°ï¼Œæ˜¯åˆ™è¡¨ç¤ºåŠ é”æˆåŠŸï¼›å¦åˆ™ç›‘å¬ç‰ˆæœ¬å·å°äºè‡ªå·±ä½†æœ€æ¥è¿‘è‡ªå·±çš„é‚£ä¸ªkeyçš„åˆ é™¤äº‹ä»¶ã€‚<br>è¿™æ ·æ‰€æœ‰åŠ é”æ–¹ä¼š<strong>æ ¹æ®ç‰ˆæœ¬å·æ’æˆä¸€æ¡é˜Ÿåˆ—</strong>ï¼Œæ¯æ¬¡é”é‡Šæ”¾åªä¼šæƒŠåŠ¨ä¸‹ä¸€ä½ï¼ŒæƒŠç¾¤é—®é¢˜å¾—ä»¥é¿å…ã€‚</p>
<h2><span id="å®éªŒå¯¹æ¯”">å®éªŒå¯¹æ¯”</span></h2><p>è¯„ä»·æŒ‡æ ‡ä¸ºå¹³å‡åŠ é”æ—¶é—´ï¼Œå³ä»å‘èµ·é”è¯·æ±‚åˆ°æˆåŠŸè·å–é”çš„å¹³å‡æ—¶é—´ã€æ¯ç§’æˆåŠŸåŠ é”æ¬¡æ•°(LSPS)ã€P70&#x2F;P90&#x2F;P99å»¶è¿Ÿï¼Œä»¥åŠCPUä½¿ç”¨ç‡å·®å¼‚ã€‚æœ¬èŠ‚åªå±•ç¤ºå®è§‚ä¸Šçš„å®éªŒç»“è®ºï¼Œä¸å±•ç¤ºå…·ä½“æ•°å€¼ã€‚</p>
<h3><span id="å»¶è¿Ÿ-ååé‡å¯¹æ¯”">å»¶è¿Ÿã€ååé‡å¯¹æ¯”</span></h3><p>åœ¨<strong>å¹¶å‘é‡è¾ƒå°ï¼Œä½†åŠ é”é¢‘ç¹</strong>çš„åœºæ™¯ä¸‹ï¼Œä¸»åŠ¨è½®è¯¢å‹é”çš„å¹³å‡åŠ é”æ—¶é—´è¾ƒä½ï¼Œä½†æ˜¯<strong>é•¿å°¾æ•ˆåº”æ˜¾è‘—</strong>ï¼Œçº¦æœ‰10%çš„åŠ é”æ—¶é—´ä¸ºå¹³å‡æ—¶é—´çš„10-20å€ï¼›è€Œç›‘å¬å›è°ƒå‹é”çš„å¹³å‡åŠ é”æ—¶é—´åœ¨ä¸æ–­ä¸Šå‡ï¼Œæ¯ç§’åŠ é”æˆåŠŸæ•°ä¸æ–­ä¸‹é™ï¼Œè¯´æ˜å…¶<strong>å¤„ç†èƒ½åŠ›åœ¨é€æ¸ä¸‹é™</strong>ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºé¢‘ç¹è¯·æ±‚ä½¿å¾—etcdä¸­äº‹ä»¶å †ç§¯æ‰€è‡´ã€‚<br>åœ¨<strong>å¹¶å‘é‡è¾ƒå¤§</strong>çš„åœºæ™¯ä¸‹ï¼Œä¸»åŠ¨è½®è¯¢å‹é”çš„å¹³å‡åŠ é”æ—¶é—´éšç«äº‰æ•°é‡çº¿æ€§å¢é•¿ï¼Œå¹¶ä¸”éšç€ç«äº‰ç¨‹åº¦çš„æ¿€çƒˆï¼Œé•¿å°¾æ•ˆåº”æ„ˆå‘æ˜æ˜¾ã€‚åŒæ—¶å®¢æˆ·ç«¯æ•°é‡å¢åŠ 10å€ï¼ŒLSPSå‡å°‘25%ï¼›ç›‘å¬å›è°ƒå‹é”çš„å¹³å‡åŠ é”æ—¶é—´ä¸LSPSå¹¶æœªéšç€ç«äº‰ç¨‹åº¦å¢åŠ è€Œæ˜æ˜¾å˜åŒ–ï¼Œ<strong>è¾ƒä¸ºç¨³å®š</strong>ã€‚<br>ä½†æ˜¯ä¸¤ä¸ªåœºæ™¯ä¸‹ç›‘å¬å›è°ƒå‹é”çš„æ€§èƒ½å‡åŠ£äºä¸»åŠ¨è½®è¯¢å‹ï¼Œè¿™å¯èƒ½ä¸ç¬”è€…çš„å®éªŒç¯å¢ƒä»å¤„äºå•æœºçŠ¶æ€æœ‰å…³ï¼Œå¦‚ä¸å¿½ç•¥<strong>èŠ‚ç‚¹é—´çš„é€šä¿¡å»¶è¿Ÿä¸å®é™…ä»»åŠ¡å¤„ç†æ—¶é—´</strong>ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ç›‘å¬å›è°ƒå‹é”åº”è¯¥æ›´å…·ä¼˜åŠ¿ã€‚</p>
<h3><span id="èµ„æºæ¶ˆè€—å¯¹æ¯”">èµ„æºæ¶ˆè€—å¯¹æ¯”</span></h3><p>ç›‘å¬å›è°ƒå‹é”çš„CPUä½¿ç”¨ç‡çº¦æ¯”ä¸»åŠ¨è½®è¯¢å‹é”çº¦ä½10%-15%ï¼Œåœ¨é”ç«äº‰æ¿€çƒˆæ—¶CPUä½¿ç”¨ç‡çš„å·®è·æ›´åŠ æ˜æ˜¾</p>
</div><script type="text/javascript" src="/Blog/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://luozero-world.github.io/Blog/2025/05/15/fen-bu-shi-suo-zhu-dong-lun-xun-xing-vs-jian-ting-xing/" data-id="cmbglq6iy000648l74l1id8i9" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADG0lEQVR42u3aS24rORAEQN//0p7tW4zamVUtQE0FVwbcIBnUolCfn594/b5YyX///ebVnvk+1zvcvLCxsbEfwv69XNcHXB98TZpRX+2cW7CxsbFPZedbt9/MglYSAmf3xMbGxsZOQlROTdKV/ERsbGxs7E1war9Mik15aQkbGxsbOykqbUo8eQHoHV9iY2Njn81uw8wn//2W/jY2Njb2B7N/y/WOpCIPP9dpRqHAxsbGPoi9adBeH9ymE+1Nklv9cX9sbGzs49hJ+GmD1qwJ0Q6ADlsa2NjY2Mex94WkZLe72rp5c7dORbCxsbEfyN4Ud9or3pXw5Lw/bouNjY39cPas6LN5lNUvUzYG6roUNjY29hHspASf/DdvEmzSkvbm2NjY2Oex700hhmWdshXRjv4UjWRsbGzsB7JnqcI+RZmlE/uEBxsbG/sb2JvW72y4p80ONukTNjY29nnsPCy1A47tN3niMXu+4cwpNjY29sezN8M07fjjMG0YNTP+eD5sbGzs49iz9Y5hmll7ABsbG/ub2XelDZvy/SY7mLUWsLGxsU9ib0Yh7xqy2Y/71E+JjY2NfRC7RbZHruJqGbSSQcz/2R8bGxv74exZwrBJOWaBKg+lUaEKGxsb+zh2stEmhGyerB36jETY2NjYB7Hz0s++HZtMQuZh6YZvsLGxsQ9i55+2wePeolIeXGcNBmxsbOwnsvMAsGnutsFs84tFj4KNjY39Bew8dOXjMi3m3id+WU7CxsbGfjh7Vvq/qxi0GQZqC0bY2NjY38DOLzFj1IM1cUBtkyhsbGzsb2C3pfwkzPwEq90nv1tdLcPGxsZ+LHs2lNOOVOaXa+9WhD1sbGzsI9izIZs8nWgHNNuWQzuyU/xu2NjY2A9h5ytJP9rLbZoE95a0sLGxsZ/O3iQVdSmnLGkloSgf1sHGxsY+m90O5bQDOrPgd29RadW1xsbGxj6UXR9Wnj5DRnfAxsbG/mJ23sTdD+Xn6Uqe5GBjY2Ofyk6KSi1mVvrPz01SlBtqadjY2Ngfz54lDLNifYvZpBxt8QsbGxv7gez/AIqV41+QGjJTAAAAAElFTkSuQmCC">åˆ†äº«</a><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/Blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag">åˆ†å¸ƒå¼</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/Blog/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">å¤šçº¿ç¨‹</a></li></ul></div><div class="post-nav"><a class="next" href="/Blog/2025/02/23/suan-fa-mo-ban/">ç®—æ³•æ¨¡æ¿</a></div><div class="nofancybox" id="waline"></div><link rel="stylesheet" type="text/css" href="https://unpkg.com/@waline/client@v3/dist/waline.css"><script type="module">import {init} from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
init({
  el: '#waline',
  comment: true,
  serverURL: 'waline-sigma.vercel.app',
  pageSize: '10',
  wordLimit: '500',
  requiredMeta,
  emoji: [
    '//unpkg.com/@waline/emojis@1.2.0/weibo',
    '//unpkg.com/@waline/emojis@1.2.0/qq',
    '//unpkg.com/@waline/emojis@1.2.0/tw-emoji',
  ],
});</script><script>let metaInfo = ['nick', 'mail', 'link']
let requiredMeta = 'nick,mail'.split(',').filter(item => {
  return metaInfo.indexOf(item) > -1
})
</script></div><aside class="toc-article" id="toc"><div class="toc-title">æ–‡ç« ç›®å½•</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-text">ä¸»åŠ¨è½®è¯¢å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">å®ç°åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">æŠ€æœ¯éš¾ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-text">ç›‘å¬å›è°ƒå‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">å®ç°åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">æŠ€æœ¯éš¾ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-text">å®éªŒå¯¹æ¯”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">å»¶è¿Ÿã€ååé‡å¯¹æ¯”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-text">èµ„æºæ¶ˆè€—å¯¹æ¯”</span></a></li></ol></li></ol></aside></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="å…³äº"><img class="nofancybox" src="/Blog/img/myphoto.jpg"/></a><p>Premature optimization is the root of all evil.</p><a class="info-icon" href="mailto:13097638440@163.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/LuoZero-World" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://space.bilibili.com/649588534" title="Bilibili" target="_blank" style="margin-inline:5px"> <i class="fa fa-reddit-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/">æŠ€æœ¯æ€»ç»“</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/%E9%9A%8F%E7%AC%94/">éšç¬”</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/Blog/categories/%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/">é¡¹ç›®æ€»ç»“</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/Blog/tags/2023/" style="font-size: 15px;">2023</a> <a href="/Blog/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 15px;">å¤šçº¿ç¨‹</a> <a href="/Blog/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 15px;">è®¾è®¡æ¨¡å¼</a> <a href="/Blog/tags/JUC/" style="font-size: 15px;">JUC</a> <a href="/Blog/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 15px;">åŸºç¡€çŸ¥è¯†</a> <a href="/Blog/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 15px;">åˆ†å¸ƒå¼</a> <a href="/Blog/tags/2024/" style="font-size: 15px;">2024</a> <a href="/Blog/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">ç®—æ³•</a> <a href="/Blog/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" style="font-size: 15px;">åŠ¨æ€è§„åˆ’</a> <a href="/Blog/tags/%E5%9B%BE%E8%AE%BA/" style="font-size: 15px;">å›¾è®º</a> <a href="/Blog/tags/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/" style="font-size: 15px;">æ¨èç³»ç»Ÿ</a> <a href="/Blog/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/Blog/tags/Nginx/" style="font-size: 15px;">Nginx</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/Blog/2025/05/15/fen-bu-shi-suo-zhu-dong-lun-xun-xing-vs-jian-ting-xing/">åˆ†å¸ƒå¼é”ï¼šä¸»åŠ¨è½®è¯¢å‹vsç›‘å¬å›è°ƒå‹</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2025/02/23/suan-fa-mo-ban/">ç®—æ³•æ¨¡æ¿</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2025/01/12/hu-lun-tun-zao-yu-hou-ji/">å›«å›µåæ£ä¸2024åè®°</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2024/06/12/yin-le-tui-jian-xi-tong/">éŸ³ä¹æ¨èç³»ç»Ÿ</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2024/05/23/java-duo-xian-cheng-she-ji-mo-shi/">Javaå¤šçº¿ç¨‹è®¾è®¡æ¨¡å¼</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2023/12/28/2023-zhe-yi-nian/">2023è¿™ä¸€å¹´</a></li><li class="post-list-item"><a class="post-list-link" href="/Blog/2023/10/07/java-he-xin-ji-zhu/">Javaæ ¸å¿ƒæŠ€æœ¯I (Version.12)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="https://chuixue-lan.github.io/Blog/" title="å¹é›ªã®åšå®¢" target="_blank">å¹é›ªã®åšå®¢</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2025 <a href="/Blog/." rel="nofollow">LuoZero's World.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/Blog/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/Blog/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/Blog/css/search.css?v=1.0.0"><script type="text/javascript" src="/Blog/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/Blog/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/Blog/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸï¼"></script><link rel="stylesheet" type="text/css" href="/Blog/css/copycode.css?v=1.0.0"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/Blog/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/Blog/js/smartresize.js?v=1.0.0"></script></div></body></html>